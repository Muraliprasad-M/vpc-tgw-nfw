
trigger:
  branches:
    include: [ main ]

pool:
  vmImage: ubuntu-latest

variables:
  TF_IN_AUTOMATION: "true"
  AWS_REGION: "eu-west-2"
  TERRAFORM_VERSION: "1.6.6"
  TF_BACKEND_BUCKET: "my-tfstate-bucket"
  TF_BACKEND_KEY:    "net/vpc-it/terraform.tfstate"
  TF_BACKEND_DDB:    "my-tfstate-locks"

stages:
- stage: validate_and_plan
  displayName: "Validate & Plan"
  jobs:
  - job: plan
    displayName: "Terraform fmt/validate/plan"
    steps:
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "$(TERRAFORM_VERSION)"

    - task: AWSShellScript@1
      displayName: "Init backend + plan"
      inputs:
        awsCredentials: "aws-sc-oidc-or-assumerole"
        regionName: "$(AWS_REGION)"
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd vpc-it
          terraform --version
          terraform fmt -recursive -check
          ./scripts/init_backend.sh --bucket "$(TF_BACKEND_BUCKET)" --dynamodb "$(TF_BACKEND_DDB)" --region "$(AWS_REGION)" --key "$(TF_BACKEND_KEY)"
          terraform init -backend-config=backend.hcl
          terraform validate
          terraform plan -out=tfplan

    - publish: vpc-it
      artifact: vpc-code

- stage: apply
  displayName: "Manual approval â†’ Apply"
  dependsOn: validate_and_plan
  condition: succeeded()
  jobs:
  - deployment: apply
    displayName: "Terraform apply"
    environment: "net-approval"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: vpc-code

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
            displayName: "Install Terraform"
            inputs:
              terraformVersion: "$(TERRAFORM_VERSION)"

          - task: AWSShellScript@1
            displayName: "Terraform apply"
            inputs:
              awsCredentials: "aws-sc-oidc-or-assumerole"
              regionName: "$(AWS_REGION)"
              scriptType: inline
              inlineScript: |
                set -euo pipefail
                cd $(Pipeline.Workspace)/vpc-code
                terraform init -backend-config=backend.hcl
                terraform apply -auto-approve tfplan
